<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
        http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <changeSet id="ENDTB-201605101556" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_answer where concept_id = 792 and answer_concept = 1648
            </sqlCheck>
        </preConditions>
        <comment>Adding 'Unable to or did not access' option to 'Followup, Ankle reflexes in left'</comment>
        <sql>
            insert into concept_answer (concept_id,answer_concept,creator,date_created,sort_weight,uuid)
            values (792,1648,4,now(),6,uuid());
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605101601" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_answer where concept_id = 793 and answer_concept = 1648
            </sqlCheck>
        </preConditions>
        <comment>Adding 'Unable to or did not access' option to 'Followup, Vibration Perception in Left'</comment>
        <sql>
            insert into concept_answer (concept_id,answer_concept,creator,date_created,sort_weight,uuid)
            values (793,1648,4,now(),5,uuid());
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605101705" author="Mahesh">
        <comment>Updating INCORRECT to CORRECT plates in Baseline and Followup forms</comment>
        <sql>
            update concept_name set name = 'Followup, Left Eye Correct Plates' where concept_id = 181 and concept_name_type = 'FULLY_SPECIFIED';
            update concept_name set name = 'Followup, Right Eye Correct Plates' where concept_id = 182 and concept_name_type = 'FULLY_SPECIFIED';
            update concept_name set name = 'Followup, Correct plates' where concept_id = 189 and concept_name_type = 'FULLY_SPECIFIED';
            update concept_name set name = 'Number of Correct Plates' where concept_id = 189 and concept_name_type = 'SHORT';
            update concept_name set name = 'Baseline, Left Eye Correct Plates' where concept_id = 316 and concept_name_type = 'FULLY_SPECIFIED';
            update concept_name set name = 'Baseline, Right Eye Correct Plates' where concept_id = 317 and concept_name_type = 'FULLY_SPECIFIED';
            update concept_name set name = 'Number of Correct Plates' where concept_id = 362 and concept_name_type = 'SHORT';
            update concept_name set name = 'Baseline, Correct plates' where concept_id = 362 and concept_name_type = 'FULLY_SPECIFIED';
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605111155" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_answer where concept_id = 799 and answer_concept = 1648
            </sqlCheck>
        </preConditions>
        <comment>Adding 'Unable to or did not access' option to 'Followup, Ankle reflexes in right'</comment>
        <sql>
            insert into concept_answer (concept_id,answer_concept,creator,date_created,sort_weight,uuid)
            values (799,1648,4,now(),6,uuid());
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605111157" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_answer where concept_id = 798 and answer_concept = 1648
            </sqlCheck>
        </preConditions>
        <comment>Adding 'Unable to or did not access' option to 'Followup, Vibration Perception in Right'</comment>
        <sql>
            insert into concept_answer (concept_id,answer_concept,creator,date_created,sort_weight,uuid)
            values (798,1648,4,now(),5,uuid());
        </sql>
    </changeSet>
    <changeSet id="ENDTB-20160524112300" author="shivakumar">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*)  from concept_reference_source where name="EndTB-Export";
            </sqlCheck>
        </preConditions>
        <comment>adding new concept_reference_source</comment>
        <sql>
            update concept_reference_source set hl7_code = null where hl7_code = '';
            insert into concept_reference_source (name,description,creator,date_created,uuid) values ('EndTB-Export','Codes for output in endTB exports',1,now(),uuid());
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605250907" author="Shruthi">
        <comment>Adding a procedure to create a concept reference mapping</comment>
        <sql>
            DROP PROCEDURE IF EXISTS CREATE_REFERENCE_MAPPING;
        </sql>
        <sqlFile splitStatements="false" path="CreateReferenceMapping.sql"/>
    </changeSet>
    <changeSet id="ENDTB-201605271117" author="Mahesh">
        <comment>Adding reference terms for endTB exports codes</comment>
        <sqlFile path="export_ref_terms.sql"/>
    </changeSet>
    <changeSet id="ENDTB-201605271537" author="Mahesh">
        <comment>Mapping export codes with respective concepts</comment>
        <sqlFile path="concept_ref_map.sql"/>
    </changeSet>
    <changeSet id="ENDTB-201605271655" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from concept_view where concept_full_name = 'Bacteriology, Smear test lab ID number' and concept_datatype_name = 'Numeric';
            </sqlCheck>
        </preConditions>
        <comment>Migrating Smear test lab ID from numeric to text</comment>
        <sql>
		select concept_id into @conceptID from concept_view where concept_full_name = 'Bacteriology, Smear test lab ID number';
		update obs set value_text = concat(value_numeric) where concept_id = @conceptID;
		update concept set datatype_id = (select concept_datatype_id from concept_datatype where name = 'Text') where concept_id = @conceptID;
		update obs set value_numeric = NULL where concept_id = @conceptID;
		delete from concept_numeric where concept_id = @conceptID;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605271710" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from concept_view where concept_full_name = 'Bacteriology, Xpert test ID number' and concept_datatype_name = 'Numeric';
            </sqlCheck>
        </preConditions>
        <comment>Migrating Xpert test ID from numeric to text</comment>
        <sql>
                select concept_id into @conceptID from concept_view where concept_full_name = 'Bacteriology, Xpert test ID number';
                update obs set value_text = concat(value_numeric) where concept_id = @conceptID;
                update concept set datatype_id = (select concept_datatype_id from concept_datatype where name = 'Text') where concept_id = @conceptID;
                update obs set value_numeric = NULL where concept_id = @conceptID;
                delete from concept_numeric where concept_id = @conceptID;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605271711" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from concept_view where concept_full_name = 'Bacteriology, HAIN MTBDRplus test lab ID' and concept_datatype_name = 'Numeric';
            </sqlCheck>
        </preConditions>
        <comment>Migrating HAIN MTBDRplus test lab ID from numeric to text</comment>
        <sql>
                select concept_id into @conceptID from concept_view where concept_full_name = 'Bacteriology, HAIN MTBDRplus test lab ID';
                update obs set value_text = concat(value_numeric) where concept_id = @conceptID;
                update concept set datatype_id = (select concept_datatype_id from concept_datatype where name = 'Text') where concept_id = @conceptID;
                update obs set value_numeric = NULL where concept_id = @conceptID;
                delete from concept_numeric where concept_id = @conceptID;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605271712" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from concept_view where concept_full_name = 'Bacteriology, HAIN MTBDRsl test ID' and concept_datatype_name = 'Numeric';
            </sqlCheck>
        </preConditions>
        <comment>Migrating HAIN MTBDRsl test ID from numeric to text</comment>
        <sql>
                select concept_id into @conceptID from concept_view where concept_full_name = 'Bacteriology, HAIN MTBDRsl test ID';
                update obs set value_text = concat(value_numeric) where concept_id = @conceptID;
                update concept set datatype_id = (select concept_datatype_id from concept_datatype where name = 'Text') where concept_id = @conceptID;
                update obs set value_numeric = NULL where concept_id = @conceptID;
                delete from concept_numeric where concept_id = @conceptID;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605271713" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                select count(*) from concept_view where concept_full_name = 'Bacteriology, Culture test lab ID' and concept_datatype_name = 'Numeric';
            </sqlCheck>
        </preConditions>
        <comment>Migrating Culture test lab ID from numeric to text</comment>
        <sql>
                select concept_id into @conceptID from concept_view where concept_full_name = 'Bacteriology, Culture test lab ID';
                update obs set value_text = concat(value_numeric) where concept_id = @conceptID;
                update concept set datatype_id = (select concept_datatype_id from concept_datatype where name = 'Text') where concept_id = @conceptID;
                update obs set value_numeric = NULL where concept_id = @conceptID;
                delete from concept_numeric where concept_id = @conceptID;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605280823" author="Mahesh">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                select count(*) from concept_name where concept_id = 224 and locale = 'en' and concept_name_type = 'SHORT' and voided = 0;
            </sqlCheck>
        </preConditions>
        <comment>Updating Gatifloxacin drug shortname</comment>
        <sql>
		update concept_name set name = 'Gatifloxacin (Gtx)', voided = 0, voided_by = null, date_voided = null where concept_id = 224 and concept_name_type = 'SHORT' and locale = 'en';
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605280829" author="Mahesh">
        <comment>Updating order of drugs for the field Past TB Drugs more than 1 month in Past TB Treatment</comment>
        <sql>
                update concept_answer set sort_weight = 1 where concept_id = 278 and answer_concept = 221;
		update concept_answer set sort_weight = 2 where concept_id = 278 and answer_concept = 1225;
		update concept_answer set sort_weight = 3 where concept_id = 278 and answer_concept = 237;
		update concept_answer set sort_weight = 4 where concept_id = 278 and answer_concept = 1226;
		update concept_answer set sort_weight = 5 where concept_id = 278 and answer_concept = 238;
		update concept_answer set sort_weight = 6 where concept_id = 278 and answer_concept = 240;
		update concept_answer set sort_weight = 7 where concept_id = 278 and answer_concept = 215;
		update concept_answer set sort_weight = 8 where concept_id = 278 and answer_concept = 219;
		update concept_answer set sort_weight = 9 where concept_id = 278 and answer_concept = 227;
		update concept_answer set sort_weight = 10 where concept_id = 278 and answer_concept = 242;
		update concept_answer set sort_weight = 11 where concept_id = 278 and answer_concept = 217;
		update concept_answer set sort_weight = 12 where concept_id = 278 and answer_concept = 224;
		update concept_answer set sort_weight = 13 where concept_id = 278 and answer_concept = 228;
		update concept_answer set sort_weight = 14 where concept_id = 278 and answer_concept = 231;
		update concept_answer set sort_weight = 15 where concept_id = 278 and answer_concept = 234;
		update concept_answer set sort_weight = 16 where concept_id = 278 and answer_concept = 220;
		update concept_answer set sort_weight = 17 where concept_id = 278 and answer_concept = 223;
		update concept_answer set sort_weight = 18 where concept_id = 278 and answer_concept = 235;
		update concept_answer set sort_weight = 19 where concept_id = 278 and answer_concept = 1227;
		update concept_answer set sort_weight = 20 where concept_id = 278 and answer_concept = 236;
		update concept_answer set sort_weight = 21 where concept_id = 278 and answer_concept = 244;
		update concept_answer set sort_weight = 22 where concept_id = 278 and answer_concept = 216;
		update concept_answer set sort_weight = 23 where concept_id = 278 and answer_concept = 1251;
		update concept_answer set sort_weight = 24 where concept_id = 278 and answer_concept = 1258;
		update concept_answer set sort_weight = 25 where concept_id = 278 and answer_concept = 218;
		update concept_answer set sort_weight = 26 where concept_id = 278 and answer_concept = 1252;
		update concept_answer set sort_weight = 27 where concept_id = 278 and answer_concept = 1228;
		update concept_answer set sort_weight = 28 where concept_id = 278 and answer_concept = 229;
		update concept_answer set sort_weight = 29 where concept_id = 278 and answer_concept = 230;
		update concept_answer set sort_weight = 30 where concept_id = 278 and answer_concept = 243;
        </sql>
    </changeSet>
    <changeSet id="ENDTB-201605280836" author="Mahesh">
        <comment>Updating the drugs for the field Past TB Drug Regimen in Past TB Treatment Table</comment>
        <sql>
		update concept_answer set sort_weight = 1 where concept_id = 731 and answer_concept = 221;
		update concept_answer set sort_weight = 2 where concept_id = 731 and answer_concept = 1225;
		update concept_answer set sort_weight = 3 where concept_id = 731 and answer_concept = 237;
		update concept_answer set sort_weight = 4 where concept_id = 731 and answer_concept = 1226;
		update concept_answer set sort_weight = 7 where concept_id = 731 and answer_concept = 215;
		update concept_answer set sort_weight = 8 where concept_id = 731 and answer_concept = 219;
		update concept_answer set sort_weight = 9 where concept_id = 731 and answer_concept = 227;
		update concept_answer set sort_weight = 10 where concept_id = 731 and answer_concept = 242;
		update concept_answer set sort_weight = 13 where concept_id = 731 and answer_concept = 228;
		update concept_answer set sort_weight = 14 where concept_id = 731 and answer_concept = 231;
		update concept_answer set sort_weight = 16 where concept_id = 731 and answer_concept = 220;
		update concept_answer set sort_weight = 17 where concept_id = 731 and answer_concept = 223;
		update concept_answer set sort_weight = 18 where concept_id = 731 and answer_concept = 235;
		update concept_answer set sort_weight = 19 where concept_id = 731 and answer_concept = 1227;
		update concept_answer set sort_weight = 20 where concept_id = 731 and answer_concept = 236;
		update concept_answer set sort_weight = 21 where concept_id = 731 and answer_concept = 244;
		update concept_answer set sort_weight = 22 where concept_id = 731 and answer_concept = 216;
		update concept_answer set sort_weight = 23 where concept_id = 731 and answer_concept = 1251;
		update concept_answer set sort_weight = 25 where concept_id = 731 and answer_concept = 218;
		update concept_answer set sort_weight = 26 where concept_id = 731 and answer_concept = 1252;
		update concept_answer set sort_weight = 27 where concept_id = 731 and answer_concept = 1228;
		update concept_answer set sort_weight = 28 where concept_id = 731 and answer_concept = 229;
		update concept_answer set sort_weight = 29 where concept_id = 731 and answer_concept = 230;

		insert into concept_answer(concept_id, answer_concept, creator, date_created, sort_weight, uuid) values 
			(731,217,4,now(),11,uuid()),
			(731,224,4,now(),12,uuid()),
			(731,234,4,now(),15,uuid()),
			(731,238,4,now(),5,uuid()),
			(731,240,4,now(),6,uuid()),
			(731,243,4,now(),30,uuid()),
			(731,1258,4,now(),24,uuid());
        </sql>
    </changeSet>
</databaseChangeLog>
